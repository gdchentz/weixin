<!-- pages/ble/index.wxml -->
<view class="page-container">
  <!-- 设备管理区域 -->
  <view class="content-area">
    <!-- 设备发现区域 -->
    <view class="device-panel" wx:if="{{!connected}}">
      <view class="control-group">
        <button class="btn btn-primary" bindtap="initBluetooth" wx:if="{{!connecting}}">启动蓝牙</button>
        <button class="btn btn-loading" disabled wx:if="{{connecting}}">
          <view class="loading-circle"></view>
          连接中{{retryCount > 0 ? '(重试' + retryCount + '次)' : ''}}
        </button>
      </view>
      
      <view class="device-section" wx:if="{{devices.length || showDeviceList}}">
        <text class="section-title">发现设备</text>
        <scroll-view scroll-y class="device-scroll">
          <view class="device-container">
            <block wx:for="{{devices}}" wx:key="deviceId">
              <view class="device-card" bindtap="connectDevice" data-id="{{item.deviceId}}">
                <view class="device-header">
                  <text class="device-name">{{item.localName || item.name || '未知设备'}}</text>
                  <view class="device-rssi">
                    <!-- 修复：信号强度显示方向 -->
                    <view class="signal-icon" style="height: {{item.RSSI ?  item.RSSI * 0.5 : 0}}rpx"></view>
                    <text>{{item.RSSI || '未知'}}dBm</text>
                  </view>
                </view>
                <text class="device-id">{{item.deviceId.substr(0,12)}}...</text>
              </view>
            </block>
          </view>
        </scroll-view>
      </view>
    </view>
    
    <!-- 已连接设备面板 -->
    <view class="connected-panel" wx:if="{{connected}}">
      <view class="device-header">
        <text class="device-status">已连接</text>
        <text class="device-name">{{currentDevice.localName || currentDevice.name || deviceId.substr(0,12)}}</text>
      </view>
      
      <view class="connection-details">
        <!-- 修复：设备ID显示 -->
        <view class="detail-card">
          <text class="detail-label">设备ID</text>
          <text class="detail-value">{{deviceId ? deviceId.substr(0,12) + '...' : '未知'}}</text>
        </view>
        <view class="detail-card">
          <text class="detail-label">信号强度</text>
          <view class="signal-section">
            <view class="signal-indicator">
              <view class="signal-bars">
                <!-- 修复：信号柱形图上色方向 -->
                <view class="signal-bar {{currentDevice.RSSI >= -95 ? 'active' : ''}}"></view>
                <view class="signal-bar {{currentDevice.RSSI >= -85 ? 'active' : ''}}"></view>
                <view class="signal-bar {{currentDevice.RSSI >= -75 ? 'active' : ''}}"></view>
                <view class="signal-bar {{currentDevice.RSSI >= -65 ? 'active' : ''}}"></view>
              </view>
              <view class="signal-info">
                <view class="signal-value-row">
                  <text class="signal-value">{{currentDevice.RSSI || '未知'}}dBm</text>
                  <text class="distance-indicator {{getDistanceClass(currentDevice.RSSI)}}">
                    {{getDistanceText(currentDevice.RSSI)}}
                  </text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="action-group">
        <button class="btn btn-command" bindtap="sendData">发送测试数据</button>
        <button class="btn btn-danger" bindtap="disconnect">断开连接</button>
      </view>
      
      <!-- 发送数据面板 -->
      <view class="senddata-panel">
        <text class="section-title">发送的数据</text>
        <view class="senddata-view">
          <textarea class="senddata-content" 
                    value="{{sendData}}" 
                    bindinput="onSendDataInput" 
                    placeholder="输入要发送的数据..."></textarea>
        </view>
      </view>
      
      <view class="data-panel">
        <text class="section-title">接收数据</text>
        <view class="data-view">
          <text class="data-content">{{receivedData || '等待数据...'}}</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 日志面板 -->
  <view class="log-panel">
    <view class="log-header">
      <text class="section-title">操作日志</text>
      <view class="panel-actions">
        <button class="btn-text" bindtap="clearLog">清空日志</button>
      </view>
    </view>
    
    <scroll-view scroll-y class="log-scroll" scroll-top="{{logScrollTop}}">
      <view class="log-content">
        <block wx:for="{{log}}" wx:key="index">
          <view class="log-item">
            <text class="log-message">{{item}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>
</view>